import { useState, useEffect, useMemo } from 'react'
import { TrendingUp, Loader2, AlertCircle, Download, Trash2, BarChart3, Calendar } from 'lucide-react'
import { useQuery, useQueryClient } from '@tanstack/react-query'
import { pdlApi } from '@/api/pdl'
import { enedisApi } from '@/api/enedis'
import { adminApi } from '@/api/admin'
import { useAuth } from '@/hooks/useAuth'
import type { PDL } from '@/types/api'
import toast from 'react-hot-toast'
import {
  BarChart,
  Bar,
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  ReferenceLine,
} from 'recharts'

export default function Consumption() {
  const { user } = useAuth()
  const queryClient = useQueryClient()
  const [selectedPDL, setSelectedPDL] = useState<string>('')
  const [isClearingCache, setIsClearingCache] = useState(false)
  const [showConfirmModal, setShowConfirmModal] = useState(false)
  const [isChartsExpanded, setIsChartsExpanded] = useState(false)
  const [dateRange, setDateRange] = useState<{start: string, end: string} | null>(null)
  const [selectedPowerYear, setSelectedPowerYear] = useState<number>(0)
  const [hasAttemptedAutoLoad, setHasAttemptedAutoLoad] = useState(false)
  const [isPowerSectionExpanded, setIsPowerSectionExpanded] = useState(true)
  const [isStatsSectionExpanded, setIsStatsSectionExpanded] = useState(true)
  const [isDetailSectionExpanded, setIsDetailSectionExpanded] = useState(true)
  const [selectedDetailDay, setSelectedDetailDay] = useState<number>(0)
  const [detailWeekOffset, setDetailWeekOffset] = useState<number>(0) // 0 = most recent week, 1 = previous week, 2 = 2 weeks ago, etc.

  // Fetch PDLs
  const { data: pdlsResponse } = useQuery({
    queryKey: ['pdls'],
    queryFn: () => pdlApi.list(),
  })

  const pdls = pdlsResponse?.success && Array.isArray(pdlsResponse.data) ? pdlsResponse.data : []

  // Filter only active PDLs
  const activePdls = pdls.filter(p => p.is_active)

  // Get selected PDL details
  const selectedPDLDetails = pdls.find(p => p.usage_point_id === selectedPDL)

  // Fetch consumption data with React Query
  const { data: consumptionResponse, isLoading: isLoadingConsumption } = useQuery({
    queryKey: ['consumption', selectedPDL, dateRange?.start, dateRange?.end],
    queryFn: async () => {
      if (!selectedPDL || !dateRange) return null
      return enedisApi.getConsumptionDaily(selectedPDL, {
        start: dateRange.start,
        end: dateRange.end,
        use_cache: true,
      })
    },
    enabled: !!selectedPDL && !!dateRange,
    staleTime: 1000 * 60 * 60, // 1 hour - data is considered fresh
    gcTime: 1000 * 60 * 60 * 24, // 24 hours - keep in cache
  })

  // Fetch max power data with React Query
  const { data: maxPowerResponse, isLoading: isLoadingPower } = useQuery({
    queryKey: ['maxPower', selectedPDL, dateRange?.start, dateRange?.end],
    queryFn: async () => {
      if (!selectedPDL || !dateRange) return null
      return enedisApi.getMaxPower(selectedPDL, {
        start: dateRange.start,
        end: dateRange.end,
        use_cache: true,
      })
    },
    enabled: !!selectedPDL && !!dateRange,
    staleTime: 1000 * 60 * 60, // 1 hour
    gcTime: 1000 * 60 * 60 * 24, // 24 hours
  })

  // Calculate date range for detailed data (max 1 week from yesterday)
  const detailDateRange = useMemo(() => {
    if (!dateRange) return null

    const today = new Date()
    const yesterday = new Date(today)
    yesterday.setDate(today.getDate() - 1)

    // Apply week offset: 0 = most recent week (yesterday and 6 days before)
    // 1 = previous week (7-13 days ago), 2 = 2 weeks ago (14-20 days ago), etc.
    // Each offset moves back by 7 days into history
    const offsetDays = detailWeekOffset * 7

    // End date: yesterday - offset (most recent day of the week we want to display)
    const endDate_obj = new Date(yesterday)
    endDate_obj.setDate(yesterday.getDate() - offsetDays)

    // Start: 6 days before end date (7 days total including end date)
    const startDate_obj = new Date(endDate_obj)
    startDate_obj.setDate(endDate_obj.getDate() - 6)

    const startDate = startDate_obj.getFullYear() + '-' +
                      String(startDate_obj.getMonth() + 1).padStart(2, '0') + '-' +
                      String(startDate_obj.getDate()).padStart(2, '0')
    const endDate = endDate_obj.getFullYear() + '-' +
                    String(endDate_obj.getMonth() + 1).padStart(2, '0') + '-' +
                    String(endDate_obj.getDate()).padStart(2, '0')

    return { start: startDate, end: endDate }
  }, [dateRange, detailWeekOffset])

  // Fetch detailed consumption data (load curve - 30min intervals)
  // Only fetch if PDL is active and has consumption enabled
  const shouldFetchDetail = !!selectedPDL &&
                           !!detailDateRange &&
                           selectedPDLDetails?.is_active &&
                           selectedPDLDetails?.has_consumption

  const { data: detailResponse, isLoading: isLoadingDetail } = useQuery({
    queryKey: ['consumptionDetail', selectedPDL, detailDateRange?.start, detailDateRange?.end],
    queryFn: async () => {
      if (!selectedPDL || !detailDateRange) return null
      return enedisApi.getConsumptionDetail(selectedPDL, {
        start: detailDateRange.start,
        end: detailDateRange.end,
        use_cache: true,
      })
    },
    enabled: shouldFetchDetail,
    staleTime: 1000 * 60 * 60, // 1 hour
    gcTime: 1000 * 60 * 60 * 24, // 24 hours
  })

  const consumptionData = consumptionResponse?.success ? consumptionResponse.data : null
  const maxPowerData = maxPowerResponse?.success ? maxPowerResponse.data : null
  const detailData = detailResponse?.success ? detailResponse.data : null
  const isLoading = isLoadingConsumption || isLoadingPower || isLoadingDetail

  // Check if we have data in cache (to change button text)
  const hasDataInCache = !!consumptionData || !!maxPowerData

  // Auto-select first active PDL
  useEffect(() => {
    if (activePdls.length > 0 && !selectedPDL) {
      setSelectedPDL(activePdls[0].usage_point_id)
    }
  }, [activePdls, selectedPDL])

  // Auto-expand charts when data is loaded
  useEffect(() => {
    if (consumptionData?.meter_reading?.interval_reading) {
      setIsChartsExpanded(true)
    }
  }, [consumptionData])

  // Auto-fetch data on mount if cached data exists
  useEffect(() => {
    if (selectedPDL && !hasAttemptedAutoLoad) {
      // Calculate dates for 3 years of history
      const today = new Date()
      const yesterday = new Date(today)
      yesterday.setDate(today.getDate() - 1)

      const startDate_obj = new Date(yesterday)
      startDate_obj.setDate(yesterday.getDate() - 1095)

      const startDate = startDate_obj.getFullYear() + '-' +
                        String(startDate_obj.getMonth() + 1).padStart(2, '0') + '-' +
                        String(startDate_obj.getDate()).padStart(2, '0')
      const endDate = yesterday.getFullYear() + '-' +
                      String(yesterday.getMonth() + 1).padStart(2, '0') + '-' +
                      String(yesterday.getDate()).padStart(2, '0')

      // Check if data is already in cache
      const cachedConsumption = queryClient.getQueryData(['consumption', selectedPDL, startDate, endDate])
      const cachedPower = queryClient.getQueryData(['maxPower', selectedPDL, startDate, endDate])

      // If data is in cache, set date range to display it immediately
      if (cachedConsumption || cachedPower) {
        // Use setTimeout to ensure state updates are batched correctly
        setTimeout(() => {
          setDateRange({ start: startDate, end: endDate })
          setIsChartsExpanded(true) // Auto-expand charts when loading from cache
          setHasAttemptedAutoLoad(true)
        }, 0)
      } else {
        setHasAttemptedAutoLoad(true)
      }
    }
  }, [selectedPDL, hasAttemptedAutoLoad, queryClient])

  // Reset charts when PDL changes
  useEffect(() => {
    setIsChartsExpanded(false)
    setDateRange(null)
    // Use setTimeout to ensure the reset happens before auto-load
    setTimeout(() => {
      setHasAttemptedAutoLoad(false)
    }, 0)
  }, [selectedPDL])

  const fetchConsumptionData = () => {
    if (!selectedPDL) {
      toast.error('Veuillez s√©lectionner un PDL')
      return
    }

    // Collapse charts before fetching new data
    setIsChartsExpanded(false)

    // Calculate dates for consumption and power (3 years max - 1095 days)
    // Use yesterday as end date because Enedis data is only available in J-1
    const today = new Date()

    // Get yesterday in local timezone (end date)
    const yesterday = new Date(today)
    yesterday.setDate(today.getDate() - 1)

    // Start date: 1095 days before yesterday (Enedis API max limit for daily data)
    const startDate_obj = new Date(yesterday)
    startDate_obj.setDate(yesterday.getDate() - 1095)

    // Format dates as YYYY-MM-DD in local timezone
    const startDate = startDate_obj.getFullYear() + '-' +
                      String(startDate_obj.getMonth() + 1).padStart(2, '0') + '-' +
                      String(startDate_obj.getDate()).padStart(2, '0')
    const endDate = yesterday.getFullYear() + '-' +
                    String(yesterday.getMonth() + 1).padStart(2, '0') + '-' +
                    String(yesterday.getDate()).padStart(2, '0')

    // Setting dateRange will trigger React Query to fetch data
    setDateRange({ start: startDate, end: endDate })
  }

  // Show success toast when data is loaded
  useEffect(() => {
    if (consumptionData && !isLoading) {
      toast.success('Donn√©es r√©cup√©r√©es avec succ√®s (3 ans d\'historique)')
    }
  }, [consumptionData, isLoading])

  const handleClearCacheClick = () => {
    setShowConfirmModal(true)
  }

  const confirmClearCache = async () => {
    setShowConfirmModal(false)
    setIsClearingCache(true)

    try {
      // Clear React Query cache
      queryClient.clear()

      // Clear browser cache (localStorage, sessionStorage, indexedDB)
      localStorage.clear()
      sessionStorage.clear()

      // Clear indexedDB
      const databases = await window.indexedDB.databases()
      databases.forEach(db => {
        if (db.name) {
          window.indexedDB.deleteDatabase(db.name)
        }
      })

      // Clear Redis cache via API
      const response = await adminApi.clearAllConsumptionCache()

      if (response.success) {
        const deletedKeys = (response.data as any)?.deleted_keys || 0
        toast.success(`Cache vid√© avec succ√®s ! ${deletedKeys} cl√©s Redis supprim√©es. La page va se recharger.`)

        // Reload page after 2 seconds to apply cache clearing
        setTimeout(() => {
          window.location.reload()
        }, 2000)
      } else {
        toast.error(response.error?.message || 'Erreur lors du vidage du cache Redis')
      }
    } catch (error: any) {
      toast.error(error.message || 'Erreur lors du vidage du cache')
    } finally {
      setIsClearingCache(false)
    }
  }

  // Process consumption data for charts
  const chartData = useMemo(() => {
    if (!consumptionData?.meter_reading?.interval_reading) {
      return { byYear: [], byMonth: [], byMonthComparison: [], total: 0, years: [], unit: 'W' }
    }

    const readings = consumptionData.meter_reading.interval_reading
    const unit = consumptionData.meter_reading.reading_type?.unit || 'W'
    const intervalLength = consumptionData.meter_reading.reading_type?.interval_length || 'P1D'

    // Parse interval length to determine how to handle the values
    // Format: P{number}{unit} where unit can be D (day), H (hour), M (minute)
    // Examples: P1D (1 day), P30M (30 minutes), P15M (15 minutes), P8M (8 minutes)
    //
    // IMPORTANT: Enedis API behavior:
    // - P1D (daily): values are already total energy consumption for the day in Wh ‚Üí sum directly
    // - P30M/P15M (load curve): values are average power in W over the interval ‚Üí multiply by duration
    const parseIntervalToDurationInHours = (interval: string): number => {
      // Match pattern P{number}{unit}
      const match = interval.match(/^P(\d+)([DHM])$/)
      if (!match) return 1 // Default to 1 if can't parse

      const value = parseInt(match[1], 10)
      const unit = match[2]

      switch (unit) {
        case 'D': return 1 // Daily values are already total energy, not average power
        case 'H': return value // Hours
        case 'M': return value / 60 // Minutes to hours (e.g., 30M = 0.5h, 15M = 0.25h)
        default: return 1
      }
    }

    const getIntervalMultiplier = (interval: string, valueUnit: string): number => {
      // If already in Wh (energy), no conversion needed regardless of interval
      if (valueUnit === 'Wh' || valueUnit === 'WH') return 1

      // If in W (power), need to convert to energy based on interval duration
      // Exception: P1D values from Enedis are already total daily energy even if unit says W
      if (valueUnit === 'W') {
        return parseIntervalToDurationInHours(interval)
      }

      return 1 // Default: assume values can be summed directly
    }

    const intervalMultiplier = getIntervalMultiplier(intervalLength, unit)

    const monthlyData: Record<string, number> = {}
    const monthYearData: Record<string, Record<string, number>> = {} // month -> {year -> value}
    let totalConsumption = 0

    // Find the most recent date in the actual data (not assumed)
    let mostRecentDate = new Date(0) // Start with epoch
    readings.forEach((reading: any) => {
      const dateStr = reading.date?.split('T')[0] || reading.date
      if (dateStr) {
        const readingDate = new Date(dateStr)
        if (readingDate > mostRecentDate) {
          mostRecentDate = readingDate
        }
      }
    })

    // Define 365-day periods (sliding windows)
    const period1End = mostRecentDate
    const period1Start = new Date(mostRecentDate.getTime() - 365 * 24 * 60 * 60 * 1000)
    const period2End = new Date(mostRecentDate.getTime() - 365 * 24 * 60 * 60 * 1000)
    const period2Start = new Date(mostRecentDate.getTime() - 730 * 24 * 60 * 60 * 1000)
    const period3End = new Date(mostRecentDate.getTime() - 730 * 24 * 60 * 60 * 1000)
    const period3Start = new Date(mostRecentDate.getTime() - 1095 * 24 * 60 * 60 * 1000)

    const periods = [
      {
        label: String(period1End.getFullYear()),
        startDaysAgo: 0,
        endDaysAgo: 365,
        startDate: period1Start,
        endDate: period1End
      },
      {
        label: String(period2End.getFullYear()),
        startDaysAgo: 365,
        endDaysAgo: 730,
        startDate: period2Start,
        endDate: period2End
      },
      {
        label: String(period3End.getFullYear()),
        startDaysAgo: 730,
        endDaysAgo: 1095,
        startDate: period3Start,
        endDate: period3End
      }
    ]

    // Aggregate by 365-day periods
    const periodData: Record<string, { value: number, startDate: Date, endDate: Date }> = {}

    readings.forEach((reading: any) => {
      const rawValue = parseFloat(reading.value || 0)
      const dateStr = reading.date?.split('T')[0] || reading.date

      if (!dateStr || isNaN(rawValue)) return

      // Apply interval multiplier to convert to Wh if needed
      const value = rawValue * intervalMultiplier

      const readingDate = new Date(dateStr)
      const year = dateStr.substring(0, 4)
      const month = dateStr.substring(0, 7) // YYYY-MM
      const monthOnly = dateStr.substring(5, 7) // MM

      // Find which period this reading belongs to
      periods.forEach(period => {
        if (readingDate >= period.startDate && readingDate <= period.endDate) {
          if (!periodData[period.label]) {
            periodData[period.label] = {
              value: 0,
              startDate: period.startDate,
              endDate: period.endDate
            }
          }
          periodData[period.label].value += value
        }
      })

      // Aggregate by month (for monthly chart)
      monthlyData[month] = (monthlyData[month] || 0) + value

      // Aggregate by month for year comparison
      if (!monthYearData[monthOnly]) {
        monthYearData[monthOnly] = {}
      }
      monthYearData[monthOnly][year] = (monthYearData[monthOnly][year] || 0) + value

      totalConsumption += value
    })

    // Convert to chart format
    const byYear = Object.entries(periodData)
      .map(([label, data]) => ({
        year: label,
        consumption: Math.round(data.value),
        consommation: Math.round(data.value),
        startDate: data.startDate,
        endDate: data.endDate
      }))
      .reverse() // Most recent first

    // Get all years for compatibility
    const years = Object.keys(monthYearData).length > 0
      ? Object.keys(readings.reduce((acc: any, r: any) => {
          const year = r.date?.substring(0, 4)
          if (year) acc[year] = true
          return acc
        }, {})).sort()
      : []

    const byMonth = Object.entries(monthlyData)
      .map(([month, value]) => ({
        month,
        monthLabel: new Date(month + '-01').toLocaleDateString('fr-FR', { year: 'numeric', month: 'short' }),
        consumption: Math.round(value),
        consommation: Math.round(value),
      }))
      .sort((a, b) => a.month.localeCompare(b.month))

    // Monthly comparison across years
    const monthNames = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12']
    const monthLabels = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c']

    const byMonthComparison = monthNames.map((monthNum, idx) => {
      const row: any = {
        month: monthNum,
        monthLabel: monthLabels[idx],
      }

      years.forEach(year => {
        const value = monthYearData[monthNum]?.[year] || 0
        row[year] = Math.round(value)
      })

      return row
    })

    return {
      byYear,
      byMonth,
      byMonthComparison,
      total: Math.round(totalConsumption),
      years,
      unit,
    }
  }, [consumptionData])

  // Process max power data by year
  const powerByYearData = useMemo(() => {
    if (!maxPowerData?.meter_reading?.interval_reading) {
      return []
    }

    const readings = maxPowerData.meter_reading.interval_reading

    // Get the most recent date in the data
    let mostRecentDate = new Date(0)
    readings.forEach((reading: any) => {
      const dateStr = reading.date?.split('T')[0] || reading.date
      if (dateStr) {
        const readingDate = new Date(dateStr)
        if (readingDate > mostRecentDate) {
          mostRecentDate = readingDate
        }
      }
    })

    // Define 3 years of 365-day periods
    const period1End = mostRecentDate
    const period1Start = new Date(mostRecentDate.getTime() - 365 * 24 * 60 * 60 * 1000)
    const period2End = new Date(mostRecentDate.getTime() - 365 * 24 * 60 * 60 * 1000)
    const period2Start = new Date(mostRecentDate.getTime() - 730 * 24 * 60 * 60 * 1000)
    const period3End = new Date(mostRecentDate.getTime() - 730 * 24 * 60 * 60 * 1000)
    const period3Start = new Date(mostRecentDate.getTime() - 1095 * 24 * 60 * 60 * 1000)

    const periods = [
      { label: String(period1End.getFullYear()), startDate: period1Start, endDate: period1End, data: [] as any[] },
      { label: String(period2End.getFullYear()), startDate: period2Start, endDate: period2End, data: [] as any[] },
      { label: String(period3End.getFullYear()), startDate: period3Start, endDate: period3End, data: [] as any[] },
    ]

    // Group readings by period
    readings.forEach((reading: any) => {
      const dateStr = reading.date?.split('T')[0] || reading.date
      if (!dateStr) return

      const readingDate = new Date(dateStr)
      const power = parseFloat(reading.value || 0) / 1000 // Convert W to kW

      // Extract time from date field (format: YYYY-MM-DDTHH:MM:SS or YYYY-MM-DD HH:MM:SS)
      let time = ''
      if (reading.date?.includes('T')) {
        time = reading.date.split('T')[1]?.substring(0, 5) || '' // Get HH:MM
      } else if (reading.date?.includes(' ')) {
        time = reading.date.split(' ')[1]?.substring(0, 5) || '' // Get HH:MM
      }

      periods.forEach(period => {
        if (readingDate >= period.startDate && readingDate <= period.endDate) {
          period.data.push({
            date: dateStr,
            power: power,
            time: time,
            year: period.label
          })
        }
      })
    })

    // Sort data by date within each period
    periods.forEach(period => {
      period.data.sort((a, b) => a.date.localeCompare(b.date))
    })

    return periods.reverse() // Most recent first
  }, [maxPowerData])

  // Process detailed consumption data by day (load curve - 30min intervals)
  const detailByDayData = useMemo(() => {
    if (!detailData?.meter_reading?.interval_reading) {
      return []
    }

    const readings = detailData.meter_reading.interval_reading
    const unit = detailData.meter_reading.reading_type?.unit || 'W'
    const intervalLength = detailData.meter_reading.reading_type?.interval_length || 'P30M'

    console.log('üîç Detail Data Debug:', {
      totalReadings: readings.length,
      intervalLength,
      unit,
      firstReading: readings[0],
      lastReading: readings[readings.length - 1]
    })

    // Parse interval length to determine duration in hours
    // Format: P{number}{unit} where unit can be D (day), H (hour), M (minute)
    // Examples: P30M (30 minutes), P15M (15 minutes), P1H (1 hour)
    const parseIntervalToDurationInHours = (interval: string): number => {
      const match = interval.match(/^P(\d+)([DHM])$/)
      if (!match) return 0.5 // Default to 30 minutes (0.5h) if can't parse

      const value = parseInt(match[1], 10)
      const unit = match[2]

      switch (unit) {
        case 'D': return value * 24 // Days to hours
        case 'H': return value // Hours
        case 'M': return value / 60 // Minutes to hours (e.g., 30M = 0.5h, 15M = 0.25h)
        default: return 0.5
      }
    }

    // Get interval multiplier to convert power (W) to energy (Wh)
    // If unit is already Wh, no conversion needed
    // If unit is W (power), multiply by duration to get energy
    const getIntervalMultiplier = (interval: string, valueUnit: string): number => {
      // If already in Wh (energy), no conversion needed
      if (valueUnit === 'Wh' || valueUnit === 'WH') return 1

      // If in W (power), need to convert to energy based on interval duration
      if (valueUnit === 'W') {
        return parseIntervalToDurationInHours(interval)
      }

      return 1 // Default: assume no conversion needed
    }

    const intervalMultiplier = getIntervalMultiplier(intervalLength, unit)
    const intervalDurationHours = parseIntervalToDurationInHours(intervalLength)

    // Calculate interval duration in minutes for offset calculation
    const intervalDurationMinutes = intervalDurationHours * 60

    // Group readings by day
    const dayMap: Record<string, any[]> = {}

    readings.forEach((reading: any) => {
      if (!reading.date) return

      // Parse the API datetime to a Date object
      // Enedis convention: timestamp represents END of measurement interval
      // Example: "2025-10-20 00:00" = measurement from 19/10 23:30 to 20/10 00:00
      // We need to shift back by the interval duration to get the START time
      let apiDateTime: Date

      if (reading.date.includes('T')) {
        apiDateTime = new Date(reading.date)
      } else if (reading.date.includes(' ')) {
        apiDateTime = new Date(reading.date.replace(' ', 'T'))
      } else {
        apiDateTime = new Date(reading.date + 'T00:00:00')
      }

      // Shift backwards by interval duration to get measurement START time
      const actualDateTime = new Date(apiDateTime.getTime() - intervalDurationMinutes * 60 * 1000)

      // Extract date and time from the actual measurement start time
      const year = actualDateTime.getFullYear()
      const month = String(actualDateTime.getMonth() + 1).padStart(2, '0')
      const day = String(actualDateTime.getDate()).padStart(2, '0')
      const hours = String(actualDateTime.getHours()).padStart(2, '0')
      const minutes = String(actualDateTime.getMinutes()).padStart(2, '0')

      const dateStr = `${year}-${month}-${day}`
      const time = `${hours}:${minutes}`

      if (!dayMap[dateStr]) {
        dayMap[dateStr] = []
      }

      const rawValue = parseFloat(reading.value || 0)

      // Apply interval multiplier to get energy in Wh, then convert to kWh
      const energyWh = rawValue * intervalMultiplier
      const energyKwh = energyWh / 1000

      // For display on the graph, show average power in kW
      // Energy (Wh) / Duration (h) = Average Power (W)
      const averagePowerW = intervalDurationHours > 0 ? energyWh / intervalDurationHours : rawValue
      const averagePowerKw = averagePowerW / 1000

      dayMap[dateStr].push({
        time,
        power: averagePowerKw, // Display as average power in kW for the chart
        energyWh, // Store energy for calculations
        energyKwh, // Store energy in kWh
        rawValue, // Store original value
        datetime: actualDateTime.toISOString(), // Store actual measurement start time
        apiDatetime: reading.date // Keep original API datetime for reference
      })
    })

    // Convert to array and sort by date (most recent first)
    const days = Object.entries(dayMap)
      .map(([date, data]) => ({
        date,
        data: data.sort((a, b) => a.time.localeCompare(b.time)),
        totalEnergyKwh: data.reduce((sum, d) => sum + d.energyKwh, 0)
      }))
      .sort((a, b) => b.date.localeCompare(a.date))

    console.log('üìä Processed Detail Data:', {
      totalDays: days.length,
      daysWithCounts: days.map(d => ({
        date: d.date,
        points: d.data.length,
        totalKwh: d.totalEnergyKwh.toFixed(2),
        firstTime: d.data[0]?.time,
        lastTime: d.data[d.data.length - 1]?.time
      }))
    })

    if (days.length > 0 && days[0].data.length === 1) {
      console.error('‚ùå PROBL√àME: Un seul point par jour d√©tect√©! V√©rifier le groupement par date.')
      console.error('Premier jour exemple:', {
        date: days[0].date,
        data: days[0].data,
        rawReading: readings[0]
      })
    }

    return days
  }, [detailData])

  // Keyboard navigation for detail days (Arrow Left/Right)
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (!isDetailSectionExpanded || detailByDayData.length === 0) return

      if (e.key === 'ArrowLeft') {
        e.preventDefault()
        // Arrow left = go to more recent day (previous index since data is sorted newest first)
        // If already at first day (most recent), load next week (if not on current week)
        if (selectedDetailDay === 0 && detailWeekOffset > 0) {
          setDetailWeekOffset(prev => Math.max(0, prev - 1))
          // When going to next week (more recent), select the last day of that week
          setSelectedDetailDay(6)
          toast.success('Chargement de la semaine suivante...')
        } else if (selectedDetailDay > 0) {
          setSelectedDetailDay(prev => prev - 1)
        }
      } else if (e.key === 'ArrowRight') {
        e.preventDefault()
        // Arrow right = go to older day (next index since data is sorted newest first)
        // If already at last day (oldest), load previous week
        if (selectedDetailDay === detailByDayData.length - 1) {
          setDetailWeekOffset(prev => prev + 1)
          // When going to previous week (older), select the first day of that week
          setSelectedDetailDay(0)
          toast.success('Chargement de la semaine pr√©c√©dente...')
        } else {
          setSelectedDetailDay(prev => prev + 1)
        }
      }
    }

    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [isDetailSectionExpanded, detailByDayData.length, selectedDetailDay, detailWeekOffset])

  return (
    <div className="w-full">
      <div className="mb-6">
        <h1 className="text-3xl font-bold mb-2 flex items-center gap-3">
          <TrendingUp className="text-primary-600 dark:text-primary-400" size={32} />
          Consommation
        </h1>
        <p className="text-gray-600 dark:text-gray-400">
          Visualisez et analysez votre consommation √©lectrique
        </p>
      </div>

      <div className="card space-y-6">
        {/* Configuration Header */}
        <div className="bg-primary-600 text-white px-4 py-3 -mx-6 -mt-6 rounded-t-lg">
          <h2 className="text-xl font-semibold">Configuration</h2>
        </div>

        <div className="space-y-6">
            {/* PDL Selection - Only show if more than one active PDL */}
            {activePdls.length > 1 && (
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Point de Livraison (PDL)
                </label>
                <select
                  value={selectedPDL}
                  onChange={(e) => setSelectedPDL(e.target.value)}
                  className="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors"
                >
                  {activePdls.map((pdl: PDL) => (
                    <option key={pdl.usage_point_id} value={pdl.usage_point_id}>
                      {pdl.name || pdl.usage_point_id}
                    </option>
                  ))}
                </select>
              </div>
            )}

            {/* No active PDL message */}
            {activePdls.length === 0 && (
              <div className="text-sm text-gray-500 dark:text-gray-400">
                Aucun PDL actif disponible. Veuillez en ajouter un depuis votre{' '}
                <a href="/dashboard" className="text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300 underline">
                  tableau de bord
                </a>.
              </div>
            )}

            {/* Fetch Button - Show if no data in cache OR if user is admin */}
            {(!hasDataInCache || user?.is_admin) && (
              <button
                onClick={fetchConsumptionData}
                disabled={!selectedPDL || isLoading}
                className="w-full bg-primary-600 hover:bg-primary-700 disabled:bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2"
              >
                {isLoading ? (
                  <>
                    <Loader2 className="animate-spin" size={20} />
                    R√©cup√©ration en cours...
                  </>
                ) : hasDataInCache ? (
                  <>
                    <Download size={20} />
                    Rafra√Æchir les donn√©es
                  </>
                ) : (
                  <>
                    <Download size={20} />
                    R√©cup√©rer 3 ans d'historique depuis Enedis
                  </>
                )}
              </button>
            )}

          {/* Clear Cache Button (Admin only) */}
          {user?.is_admin && (
            <button
              onClick={handleClearCacheClick}
              disabled={isClearingCache}
              className="w-full bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2"
            >
              {isClearingCache ? (
                <>
                  <Loader2 className="animate-spin" size={20} />
                  Vidage en cours...
                </>
              ) : (
                <>
                  <Trash2 size={20} />
                  Vider tout le cache (Navigateur + Redis)
                </>
              )}
            </button>
          )}
        </div>

        {/* Loading Progress */}
        {isLoading && dateRange && (
          <div className="mt-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-8">
            <div className="flex flex-col items-center justify-center gap-4">
              <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600"></div>
              <p className="text-gray-600 dark:text-gray-400">
                Chargement des donn√©es de consommation et de puissance...
              </p>
              <p className="text-sm text-gray-500 dark:text-gray-500">
                R√©cup√©ration depuis le cache ou l'API Enedis
              </p>
            </div>
          </div>
        )}

      </div>

      {/* Statistics Summary Section */}
      {consumptionData && chartData.total > 0 && (
        <div className={`mt-6 rounded-xl shadow-md border bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-700 transition-colors duration-200 ${
          isStatsSectionExpanded ? 'p-6' : ''
        }`}>
          <div
            className={`bg-primary-600 text-white px-4 py-3 flex items-center justify-between cursor-pointer ${
              isStatsSectionExpanded ? '-mx-6 -mt-6 rounded-t-lg' : 'rounded-lg'
            }`}
            onClick={() => setIsStatsSectionExpanded(!isStatsSectionExpanded)}
          >
            <div className="flex items-center gap-3">
              <BarChart3 size={24} />
              <h2 className="text-xl font-semibold">Statistiques de consommation</h2>
            </div>
            <div className="flex items-center gap-2">
              {isStatsSectionExpanded ? (
                <span className="text-sm">R√©duire</span>
              ) : (
                <span className="text-sm">D√©velopper</span>
              )}
              <svg
                className={`w-5 h-5 transition-transform duration-200 ${
                  isStatsSectionExpanded ? 'rotate-180' : ''
                }`}
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </div>

          {isStatsSectionExpanded && (
            <>
              {/* Data Info Badge */}
              <div className="mt-4 flex items-center gap-2 text-xs">
            <span className="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-md font-medium">
              Intervalle: {consumptionData?.meter_reading?.reading_type?.interval_length || 'P1D'}
            </span>
            <span className="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-md font-medium">
              Unit√©: {consumptionData?.meter_reading?.reading_type?.unit || 'W'}
            </span>
          </div>

          {/* Yearly Breakdown */}
          <div className="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
                Consommation par ann√©e
              </h3>
              <button
                onClick={() => {
                  const jsonData = JSON.stringify(chartData.byYear, null, 2)
                  navigator.clipboard.writeText(jsonData)
                  toast.success('Donn√©es copi√©es dans le presse-papier')
                }}
                className="flex items-center gap-2 px-3 py-1.5 text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 rounded-lg transition-colors"
              >
                <Download size={16} />
                Exporter JSON
              </button>
            </div>
            <div className="overflow-x-auto pb-2">
              <div className="inline-flex gap-3 min-w-full">
                {chartData.byYear.map((yearData) => {
                // Use the dates from the period data
                const startDateFormatted = yearData.startDate.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' })
                const endDateFormatted = yearData.endDate.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' })

                return (
                  <div key={yearData.year} className="bg-gray-50 dark:bg-gray-700/30 rounded-lg p-4 border border-gray-200 dark:border-gray-600 flex-shrink-0 w-[calc(33.333%-0.5rem)]">
                    <div className="flex flex-col gap-2">
                      <div className="flex items-center justify-between">
                        <p className="text-lg font-bold text-gray-900 dark:text-white">
                          {yearData.year}
                        </p>
                        <button
                          onClick={() => {
                            const intervalLength = consumptionData?.meter_reading?.reading_type?.interval_length || 'P1D'
                            const unit = consumptionData?.meter_reading?.reading_type?.unit || 'W'

                            // Parse interval to duration in hours
                            const parseIntervalToDurationInHours = (interval: string): number => {
                              const match = interval.match(/^P(\d+)([DHM])$/)
                              if (!match) return 1
                              const value = parseInt(match[1], 10)
                              const unit = match[2]
                              switch (unit) {
                                case 'D': return 1 // Daily values are already total energy
                                case 'H': return value
                                case 'M': return value / 60
                                default: return 1
                              }
                            }

                            // Get interval multiplier for this export
                            const getIntervalMultiplier = (interval: string, valueUnit: string): number => {
                              if (valueUnit === 'Wh' || valueUnit === 'WH') return 1
                              if (valueUnit === 'W') {
                                return parseIntervalToDurationInHours(interval)
                              }
                              return 1
                            }

                            const intervalMultiplier = getIntervalMultiplier(intervalLength, unit)

                            // Filter interval readings for this year and apply multiplier
                            const yearReadings = consumptionData?.meter_reading?.interval_reading?.filter((reading: any) => {
                              const date = reading.date?.split('T')[0] || reading.date
                              return date && date.startsWith(yearData.year)
                            }).map((reading: any) => ({
                              date: reading.date?.split('T')[0] || reading.date,
                              value_raw: parseFloat(reading.value || 0),
                              value_wh: parseFloat(reading.value || 0) * intervalMultiplier
                            })) || []

                            const jsonData = JSON.stringify({
                              year: yearData.year,
                              startDate: startDateFormatted,
                              endDate: endDateFormatted,
                              consommation_kwh: (yearData.consommation / 1000),
                              consommation_wh: yearData.consommation,
                              unit_raw: unit,
                              interval_length: intervalLength,
                              interval_multiplier: intervalMultiplier,
                              interval_readings: yearReadings,
                              total_readings: yearReadings.length
                            }, null, 2)
                            navigator.clipboard.writeText(jsonData)
                            toast.success(`Donn√©es ${yearData.year} copi√©es (${yearReadings.length} lectures)`)
                          }}
                          className="p-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 rounded transition-colors"
                        >
                          <Download size={14} />
                        </button>
                      </div>
                      <p className="text-xs text-gray-500 dark:text-gray-400">
                        {startDateFormatted} - {endDateFormatted}
                      </p>
                      <div className="mt-2">
                        <p className="text-xl font-bold text-blue-600 dark:text-blue-400">
                          {(yearData.consommation / 1000).toLocaleString('fr-FR', { maximumFractionDigits: 2 })} kWh
                        </p>
                        <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                          {yearData.consommation.toLocaleString('fr-FR')} {chartData.unit === 'W' ? 'W' : 'Wh'}
                        </p>
                      </div>
                    </div>
                  </div>
                )
              })}
              </div>
            </div>
          </div>
            </>
          )}
        </div>
      )}

      {/* Detailed Consumption Section - Load Curve (30min intervals) */}
      {!isLoadingConsumption && !isLoadingPower && (detailData || isLoadingDetail) && consumptionData && (
        <div className={`mt-6 rounded-xl shadow-md border bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-700 transition-colors duration-200 ${
          isDetailSectionExpanded ? 'p-6' : ''
        }`}>
          <div
            className={`bg-primary-600 text-white px-4 py-3 flex items-center justify-between cursor-pointer ${
              isDetailSectionExpanded ? '-mx-6 -mt-6 rounded-t-lg' : 'rounded-lg'
            }`}
            onClick={() => setIsDetailSectionExpanded(!isDetailSectionExpanded)}
          >
            <div className="flex items-center gap-3">
              <BarChart3 size={24} />
              <h2 className="text-xl font-semibold">Courbe de charge d√©taill√©e</h2>
            </div>
            <div className="flex items-center gap-2">
              {isDetailSectionExpanded ? (
                <span className="text-sm">R√©duire</span>
              ) : (
                <span className="text-sm">D√©velopper</span>
              )}
              <svg
                className={`w-5 h-5 transition-transform duration-200 ${
                  isDetailSectionExpanded ? 'rotate-180' : ''
                }`}
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </div>

          {isDetailSectionExpanded && (
            <div className="mt-6">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h3 className="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <TrendingUp className="text-primary-600 dark:text-primary-400" size={20} />
                    Courbe de charge d√©taill√©e
                  </h3>
                  <div className="flex items-center gap-2 mt-2 text-xs">
                    <span className="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-md font-medium">
                      Intervalle: {detailData?.meter_reading?.reading_type?.interval_length || 'P30M'}
                    </span>
                    <span className="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-md font-medium">
                      Unit√©: {detailData?.meter_reading?.reading_type?.unit || 'W'}
                    </span>
                    {detailWeekOffset > 0 && (
                      <>
                        <span className="px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded-md font-medium">
                          {detailWeekOffset === 1 ? 'Semaine pr√©c√©dente' : `Il y a ${detailWeekOffset} semaines`}
                        </span>
                        <button
                          onClick={() => setDetailWeekOffset(0)}
                          className="px-2 py-1 bg-primary-600 hover:bg-primary-700 text-white rounded-md font-medium transition-colors"
                        >
                          Retour √† aujourd'hui
                        </button>
                      </>
                    )}
                  </div>
                </div>
                <button
                  onClick={() => {
                    const jsonData = JSON.stringify(detailData, null, 2)
                    navigator.clipboard.writeText(jsonData)
                    toast.success('Donn√©es d√©taill√©es copi√©es dans le presse-papier')
                  }}
                  className="flex items-center gap-2 px-3 py-1.5 text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 rounded-lg transition-colors"
                >
                  <Download size={16} />
                  Exporter JSON
                </button>
              </div>

              {/* Day selector tabs with navigation */}
              <div className="flex items-center gap-2 mb-4">
                {/* Left button - Go to more recent (future) */}
                <button
                  onClick={() => {
                    // If already at first day (most recent) and not on current week, load next (newer) week
                    if (selectedDetailDay === 0 && detailWeekOffset > 0) {
                      setDetailWeekOffset(prev => Math.max(0, prev - 1))
                      // When going to next week (more recent), select the last day of that week (day just after)
                      setSelectedDetailDay(6) // Will be adjusted when new data loads
                      toast.success('Chargement de la semaine suivante...')
                    } else if (selectedDetailDay > 0) {
                      setSelectedDetailDay(prev => prev - 1)
                    }
                  }}
                  disabled={(selectedDetailDay === 0 && detailWeekOffset === 0) || isLoadingDetail}
                  className="flex-shrink-0 p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
                  title={selectedDetailDay === 0 && detailWeekOffset > 0 ? "Semaine suivante (plus r√©cente)" : "Jour suivant (plus r√©cent)"}
                >
                  {isLoadingDetail && selectedDetailDay === 0 ? (
                    <Loader2 className="w-5 h-5 animate-spin" />
                  ) : (
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                  )}
                </button>

                {/* Tabs container */}
                <div className="flex-1 flex gap-2 border-b border-gray-200 dark:border-gray-700 overflow-hidden">
                  {detailByDayData.map((dayData, idx) => {
                    const date = new Date(dayData.date)
                    const dayLabel = date.toLocaleDateString('fr-FR', {
                      weekday: 'short',
                      day: '2-digit',
                      month: 'short'
                    })

                    return (
                      <button
                        key={dayData.date}
                        onClick={() => setSelectedDetailDay(idx)}
                        className={`flex-1 px-4 py-3 font-medium transition-colors rounded-t-lg ${
                          selectedDetailDay === idx
                            ? 'text-primary-600 dark:text-primary-400 bg-primary-50 dark:bg-primary-900/20 border-b-2 border-primary-600 dark:border-primary-400'
                            : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/30'
                        }`}
                      >
                        <div className="flex flex-col items-center gap-1">
                          <span className="text-sm whitespace-nowrap">{dayLabel}</span>
                          <span className="text-xs font-semibold text-blue-600 dark:text-blue-400">
                            {dayData.totalEnergyKwh.toFixed(2)} kWh
                          </span>
                        </div>
                      </button>
                    )
                  })}
                </div>

                {/* Right button - Go to older (past) */}
                <button
                  onClick={() => {
                    // If already at last day (oldest), load previous (older) week
                    if (selectedDetailDay === detailByDayData.length - 1) {
                      setDetailWeekOffset(prev => prev + 1)
                      // When going to previous week (older), select the first day of that week (day just before)
                      setSelectedDetailDay(0)
                      toast.success('Chargement de la semaine pr√©c√©dente...')
                    } else {
                      setSelectedDetailDay(prev => prev + 1)
                    }
                  }}
                  disabled={isLoadingDetail}
                  className="flex-shrink-0 p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
                  title={selectedDetailDay === detailByDayData.length - 1 ? "Semaine pr√©c√©dente (plus ancienne)" : "Jour pr√©c√©dent (plus ancien)"}
                >
                  {isLoadingDetail && selectedDetailDay === detailByDayData.length - 1 ? (
                    <Loader2 className="w-5 h-5 animate-spin" />
                  ) : (
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                    </svg>
                  )}
                </button>
              </div>

              {/* Graph for selected day */}
              <div className="relative">
                {/* Always render the graph container to maintain height */}
                <div className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600 min-h-[500px]">
                  {/* Content based on state */}
                  {detailByDayData.length > 0 && detailByDayData[selectedDetailDay] ? (
                    <>
                      <div className="mb-2 text-sm text-gray-600 dark:text-gray-400">
                        {detailByDayData[selectedDetailDay].data.length} points de mesure pour cette journ√©e
                      </div>
                      <ResponsiveContainer width="100%" height={400}>
                        <LineChart data={detailByDayData[selectedDetailDay].data}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.1} />
                          <XAxis
                            dataKey="time"
                            stroke="#6B7280"
                            style={{ fontSize: '11px' }}
                            interval="preserveStartEnd"
                          />
                          <YAxis
                            stroke="#6B7280"
                            style={{ fontSize: '14px' }}
                            label={{ value: 'Puissance (kW)', angle: -90, position: 'insideLeft' }}
                            domain={[0, 'auto']}
                          />
                          <Tooltip
                            cursor={{ stroke: '#3B82F6', strokeWidth: 2 }}
                            contentStyle={{
                              backgroundColor: '#1F2937',
                              border: '1px solid #374151',
                              borderRadius: '8px',
                              color: '#F9FAFB'
                            }}
                            formatter={(value: number, _name: string, props: any) => {
                              const dataPoint = props.payload
                              if (!dataPoint) return [`${value.toFixed(3)} kW`, 'Puissance moyenne']

                              return [
                                <div key="tooltip-content" className="flex flex-col gap-1">
                                  <div className="font-semibold">{value.toFixed(3)} kW</div>
                                  <div className="text-xs text-gray-300">
                                    √ânergie: {dataPoint.energyKwh.toFixed(4)} kWh
                                  </div>
                                  <div className="text-xs text-gray-400">
                                    ({dataPoint.energyWh.toFixed(1)} Wh)
                                  </div>
                                </div>,
                                'Puissance moyenne'
                              ]
                            }}
                            labelFormatter={(label) => `Heure: ${label}`}
                          />
                          <Legend />
                          <Line
                            type="monotone"
                            dataKey="power"
                            stroke="#3B82F6"
                            strokeWidth={2}
                            dot={false}
                            activeDot={{ r: 6 }}
                            name="Consommation"
                          />
                        </LineChart>
                      </ResponsiveContainer>
                    </>
                  ) : (
                    // Empty state when no data
                    <div className="flex items-center justify-center h-[468px]">
                      <div className="flex flex-col items-center justify-center gap-4 text-center">
                        <BarChart3 className="text-gray-400 dark:text-gray-600" size={48} />
                        <p className="text-gray-600 dark:text-gray-400">
                          Aucune donn√©e d√©taill√©e disponible pour cette p√©riode
                        </p>
                        {detailDateRange && (
                          <p className="text-xs text-gray-500 dark:text-gray-500">
                            P√©riode demand√©e : du {new Date(detailDateRange.start).toLocaleDateString('fr-FR')} au {new Date(detailDateRange.end).toLocaleDateString('fr-FR')}
                          </p>
                        )}
                      </div>
                    </div>
                  )}
                </div>

                {/* Loading overlay - positioned absolutely on top */}
                {isLoadingDetail && (
                  <div className="absolute inset-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm rounded-lg flex items-center justify-center">
                    <div className="flex flex-col items-center justify-center gap-4 p-8">
                      <Loader2 className="animate-spin text-primary-600 dark:text-primary-400" size={48} />
                      <p className="text-gray-900 dark:text-white font-semibold text-center">
                        Chargement des donn√©es d√©taill√©es...
                      </p>
                      {detailDateRange && (
                        <p className="text-sm text-gray-600 dark:text-gray-400">
                          Du {new Date(detailDateRange.start).toLocaleDateString('fr-FR')} au {new Date(detailDateRange.end).toLocaleDateString('fr-FR')}
                        </p>
                      )}
                    </div>
                  </div>
                )}
              </div>

              {/* Info note - only show when we have data */}
              {detailByDayData.length > 0 && (
                <div className="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                  <p className="text-sm text-blue-800 dark:text-blue-200">
                    <strong>‚ÑπÔ∏è Note :</strong> Ces graphiques montrent votre consommation √©lectrique d√©taill√©e avec des mesures √† intervalles r√©guliers
                    ({detailData?.meter_reading?.reading_type?.interval_length === 'P30M' ? '30 minutes' :
                      detailData?.meter_reading?.reading_type?.interval_length === 'P15M' ? '15 minutes' :
                      detailData?.meter_reading?.reading_type?.interval_length || 'variables'})
                    pour les 7 derniers jours.
                    Cela vous permet d'identifier pr√©cis√©ment vos pics de consommation et d'optimiser votre utilisation.
                    <br/><br/>
                    <strong>üí° Calcul :</strong> Les valeurs sont en puissance moyenne (kW) pour chaque intervalle.
                    L'√©nergie consomm√©e pendant l'intervalle est calcul√©e en tenant compte de la dur√©e
                    (√ânergie = Puissance √ó Dur√©e). Le total journalier affich√© dans les onglets correspond √† la somme
                    de tous les intervalles de la journ√©e.
                  </p>
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {/* Charts Section - Collapsible */}
      {consumptionData && chartData.byYear.length > 0 && (
        <div className={`mt-6 rounded-xl shadow-md border bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-700 transition-colors duration-200 ${
          isChartsExpanded ? 'p-6' : ''
        }`}>
          <div
            className={`bg-primary-600 text-white px-4 py-3 flex items-center justify-between cursor-pointer ${
              isChartsExpanded ? '-mx-6 -mt-6 rounded-t-lg' : 'rounded-lg'
            }`}
            onClick={() => setIsChartsExpanded(!isChartsExpanded)}
          >
            <div className="flex items-center gap-3">
              <BarChart3 size={24} />
              <h2 className="text-xl font-semibold">
                Courbe annuelle
              </h2>
            </div>
            <div className="flex items-center gap-2">
              {isChartsExpanded ? (
                <span className="text-sm">R√©duire</span>
              ) : (
                <span className="text-sm">D√©velopper</span>
              )}
              <svg
                className={`w-5 h-5 transition-transform duration-200 ${
                  isChartsExpanded ? 'rotate-180' : ''
                }`}
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </div>

          {isChartsExpanded && (
            <div className="space-y-8 mt-6">
              {/* Yearly Consumption Chart */}
              <div>
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <Calendar className="text-primary-600 dark:text-primary-400" size={20} />
                    Consommation par ann√©e
                  </h3>
                  <button
                    onClick={() => {
                      const intervalLength = consumptionData?.meter_reading?.reading_type?.interval_length || 'P1D'
                      const unit = consumptionData?.meter_reading?.reading_type?.unit || 'W'
                      const jsonData = JSON.stringify({
                        interval_length: intervalLength,
                        unit_raw: unit,
                        data: chartData.byYear
                      }, null, 2)
                      navigator.clipboard.writeText(jsonData)
                      toast.success('Donn√©es annuelles copi√©es dans le presse-papier')
                    }}
                    className="flex items-center gap-2 px-3 py-1.5 text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 rounded-lg transition-colors"
                  >
                    <Download size={16} />
                    Exporter JSON
                  </button>
                </div>
                <div className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600">
                  <ResponsiveContainer width="100%" height={300}>
                    <BarChart data={chartData.byYear}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.1} />
                      <XAxis
                        dataKey="year"
                        stroke="#6B7280"
                        style={{ fontSize: '14px' }}
                      />
                      <YAxis
                        stroke="#6B7280"
                        style={{ fontSize: '14px' }}
                        tickFormatter={(value) => `${(value / 1000).toFixed(0)}k`}
                      />
                      <Tooltip
                        cursor={{ fill: 'rgba(59, 130, 246, 0.1)' }}
                        contentStyle={{
                          backgroundColor: '#1F2937',
                          border: '1px solid #374151',
                          borderRadius: '8px',
                          color: '#F9FAFB'
                        }}
                        formatter={(value: number) => [`${value.toLocaleString('fr-FR')} Wh`, 'Consommation']}
                      />
                      <Legend />
                      <Bar
                        dataKey="consommation"
                        fill="#3B82F6"
                        radius={[8, 8, 0, 0]}
                        name="Consommation (Wh)"
                      />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>

              {/* Monthly Comparison Chart */}
              <div>
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <TrendingUp className="text-primary-600 dark:text-primary-400" size={20} />
                    Comparaison mensuelle par ann√©e
                  </h3>
                  <button
                    onClick={() => {
                      const jsonData = JSON.stringify(chartData.byMonthComparison, null, 2)
                      navigator.clipboard.writeText(jsonData)
                      toast.success('Donn√©es mensuelles copi√©es dans le presse-papier')
                    }}
                    className="flex items-center gap-2 px-3 py-1.5 text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 rounded-lg transition-colors"
                  >
                    <Download size={16} />
                    Exporter JSON
                  </button>
                </div>
                <div className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600">
                  <ResponsiveContainer width="100%" height={350}>
                    <BarChart data={chartData.byMonthComparison}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.1} />
                      <XAxis
                        dataKey="monthLabel"
                        stroke="#6B7280"
                        style={{ fontSize: '14px' }}
                      />
                      <YAxis
                        stroke="#6B7280"
                        style={{ fontSize: '14px' }}
                        tickFormatter={(value) => `${(value / 1000).toFixed(0)}k`}
                      />
                      <Tooltip
                        cursor={{ fill: 'rgba(59, 130, 246, 0.1)' }}
                        contentStyle={{
                          backgroundColor: '#1F2937',
                          border: '1px solid #374151',
                          borderRadius: '8px',
                          color: '#F9FAFB'
                        }}
                        formatter={(value: number) => [`${value.toLocaleString('fr-FR')} Wh`, 'Consommation']}
                      />
                      <Legend />
                      {chartData.years.map((year, index) => {
                        const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899']
                        return (
                          <Bar
                            key={year}
                            dataKey={year}
                            fill={colors[index % colors.length]}
                            radius={[4, 4, 0, 0]}
                            name={year}
                          />
                        )
                      })}
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>

            </div>
          )}
        </div>
      )}

      {/* Max Power Section - Only show when data is fully loaded and not currently loading */}
      {!isLoading && maxPowerData && maxPowerData.meter_reading?.interval_reading && consumptionData && (
        <div className={`mt-6 rounded-xl shadow-md border bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-700 transition-colors duration-200 ${
          isPowerSectionExpanded ? 'p-6' : ''
        }`}>
          <div
            className={`bg-primary-600 text-white px-4 py-3 flex items-center justify-between cursor-pointer ${
              isPowerSectionExpanded ? '-mx-6 -mt-6 rounded-t-lg' : 'rounded-lg'
            }`}
            onClick={() => setIsPowerSectionExpanded(!isPowerSectionExpanded)}
          >
            <div className="flex items-center gap-3">
              <TrendingUp size={24} />
              <h2 className="text-xl font-semibold">Pics de puissance maximale</h2>
            </div>
            <div className="flex items-center gap-2">
              {isPowerSectionExpanded ? (
                <span className="text-sm">R√©duire</span>
              ) : (
                <span className="text-sm">D√©velopper</span>
              )}
              <svg
                className={`w-5 h-5 transition-transform duration-200 ${
                  isPowerSectionExpanded ? 'rotate-180' : ''
                }`}
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </div>

          {isPowerSectionExpanded && (
            <div className="mt-6">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                <TrendingUp className="text-red-600 dark:text-red-400" size={20} />
                Puissance maximale journali√®re
              </h3>
              <button
                onClick={() => {
                  const jsonData = JSON.stringify(maxPowerData, null, 2)
                  navigator.clipboard.writeText(jsonData)
                  toast.success('Donn√©es de puissance copi√©es dans le presse-papier')
                }}
                className="flex items-center gap-2 px-3 py-1.5 text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 rounded-lg transition-colors"
              >
                <Download size={16} />
                Exporter JSON
              </button>
            </div>

            {/* Tabs for year selection */}
            <div className="flex gap-2 mb-4 border-b border-gray-200 dark:border-gray-700">
              {[...powerByYearData].reverse().map((yearData, idx) => {
                const originalIdx = powerByYearData.length - 1 - idx
                return (
                  <button
                    key={yearData.label}
                    onClick={() => setSelectedPowerYear(originalIdx)}
                    className={`flex-1 px-4 py-2 font-medium transition-colors ${
                      selectedPowerYear === originalIdx
                        ? 'text-red-600 dark:text-red-400 border-b-2 border-red-600 dark:border-red-400'
                        : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'
                    }`}
                  >
                    {yearData.label}
                  </button>
                )
              })}
            </div>

            {/* Display selected year graph */}
            {powerByYearData[selectedPowerYear] && (() => {
              const yearData = powerByYearData[selectedPowerYear]
              const colors = ['#EF4444', '#F59E0B', '#10B981']
              const color = colors[selectedPowerYear % colors.length]

              return (
                <div className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600">
                  <ResponsiveContainer width="100%" height={350}>
                    <LineChart data={yearData.data}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.1} />
                      <XAxis
                        dataKey="date"
                        stroke="#6B7280"
                        style={{ fontSize: '11px' }}
                        tickFormatter={(value) => {
                          const date = new Date(value)
                          return `${date.getDate()}/${date.getMonth() + 1}`
                        }}
                        interval="preserveStartEnd"
                      />
                      <YAxis
                        stroke="#6B7280"
                        style={{ fontSize: '14px' }}
                        label={{ value: 'Puissance (kW)', angle: -90, position: 'insideLeft' }}
                        domain={[0, 'auto']}
                      />
                      <Tooltip
                        cursor={{ stroke: color, strokeWidth: 2 }}
                        contentStyle={{
                          backgroundColor: '#1F2937',
                          border: '1px solid #374151',
                          borderRadius: '8px',
                          color: '#F9FAFB'
                        }}
                        formatter={(value: number, _name: string, props: any) => {
                          const time = props.payload?.time
                          if (time) {
                            return [`${value.toFixed(2)} kW √† ${time}`, 'Puissance max']
                          }
                          return [`${value.toFixed(2)} kW`, 'Puissance max']
                        }}
                        labelFormatter={(label) => {
                          const date = new Date(label)
                          return date.toLocaleDateString('fr-FR')
                        }}
                      />
                      <Legend />

                      {/* Reference line for subscribed power */}
                      {selectedPDLDetails?.subscribed_power && (
                        <ReferenceLine
                          y={selectedPDLDetails.subscribed_power}
                          stroke="#8B5CF6"
                          strokeWidth={2}
                          strokeDasharray="5 5"
                          label={{
                            value: `Puissance souscrite: ${selectedPDLDetails.subscribed_power} kVA`,
                            position: 'insideTopRight',
                            fill: '#8B5CF6',
                            fontSize: 12
                          }}
                        />
                      )}

                      <Line
                        type="monotone"
                        dataKey="power"
                        stroke={color}
                        strokeWidth={2}
                        dot={false}
                        activeDot={{ r: 6 }}
                        name={`Puissance max ${yearData.label}`}
                      />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              )
            })()}

            <div className="mt-4 p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg">
              <p className="text-sm text-amber-800 dark:text-amber-200">
                <strong>‚ÑπÔ∏è Note :</strong> Ces graphiques montrent les pics de puissance maximale atteints chaque jour sur les 3 derni√®res ann√©es.
                {selectedPDLDetails?.subscribed_power && (
                  <> La ligne violette en pointill√©s indique votre puissance souscrite ({selectedPDLDetails.subscribed_power} kVA).
                  Si les pics d√©passent r√©guli√®rement cette ligne, vous risquez de disjoncter.</>
                )}
              </p>
            </div>
          </div>
          )}
        </div>
      )}

      {/* Detailed Consumption Section - Load Curve (30min intervals) */}
      {!isLoadingConsumption && !isLoadingPower && (detailData || isLoadingDetail) && consumptionData && (
        <div className={`mt-6 rounded-xl shadow-md border bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-700 transition-colors duration-200 ${
          isDetailSectionExpanded ? 'p-6' : ''
        }`}>
          <div
            className={`bg-primary-600 text-white px-4 py-3 flex items-center justify-between cursor-pointer ${
              isDetailSectionExpanded ? '-mx-6 -mt-6 rounded-t-lg' : 'rounded-lg'
            }`}
            onClick={() => setIsDetailSectionExpanded(!isDetailSectionExpanded)}
          >
            <div className="flex items-center gap-3">
              <BarChart3 size={24} />
              <h2 className="text-xl font-semibold">Courbe de charge d√©taill√©e</h2>
            </div>
            <div className="flex items-center gap-2">
              {isDetailSectionExpanded ? (
                <span className="text-sm">R√©duire</span>
              ) : (
                <span className="text-sm">D√©velopper</span>
              )}
              <svg
                className={`w-5 h-5 transition-transform duration-200 ${
                  isDetailSectionExpanded ? 'rotate-180' : ''
                }`}
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </div>

          {isDetailSectionExpanded && (
            <div className="mt-6">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h3 className="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <TrendingUp className="text-primary-600 dark:text-primary-400" size={20} />
                    Courbe de charge d√©taill√©e
                  </h3>
                  <div className="flex items-center gap-2 mt-2 text-xs">
                    <span className="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-md font-medium">
                      Intervalle: {detailData?.meter_reading?.reading_type?.interval_length || 'P30M'}
                    </span>
                    <span className="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-md font-medium">
                      Unit√©: {detailData?.meter_reading?.reading_type?.unit || 'W'}
                    </span>
                    {detailWeekOffset > 0 && (
                      <>
                        <span className="px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded-md font-medium">
                          {detailWeekOffset === 1 ? 'Semaine pr√©c√©dente' : `Il y a ${detailWeekOffset} semaines`}
                        </span>
                        <button
                          onClick={() => setDetailWeekOffset(0)}
                          className="px-2 py-1 bg-primary-600 hover:bg-primary-700 text-white rounded-md font-medium transition-colors"
                        >
                          Retour √† aujourd'hui
                        </button>
                      </>
                    )}
                  </div>
                </div>
                <button
                  onClick={() => {
                    const jsonData = JSON.stringify(detailData, null, 2)
                    navigator.clipboard.writeText(jsonData)
                    toast.success('Donn√©es d√©taill√©es copi√©es dans le presse-papier')
                  }}
                  className="flex items-center gap-2 px-3 py-1.5 text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 rounded-lg transition-colors"
                >
                  <Download size={16} />
                  Exporter JSON
                </button>
              </div>

              {/* Day selector tabs with navigation */}
              <div className="flex items-center gap-2 mb-4">
                {/* Left button - Go to more recent (future) */}
                <button
                  onClick={() => {
                    // If already at first day (most recent) and not on current week, load next (newer) week
                    if (selectedDetailDay === 0 && detailWeekOffset > 0) {
                      setDetailWeekOffset(prev => Math.max(0, prev - 1))
                      // When going to next week (more recent), select the last day of that week (day just after)
                      setSelectedDetailDay(6) // Will be adjusted when new data loads
                      toast.success('Chargement de la semaine suivante...')
                    } else if (selectedDetailDay > 0) {
                      setSelectedDetailDay(prev => prev - 1)
                    }
                  }}
                  disabled={(selectedDetailDay === 0 && detailWeekOffset === 0) || isLoadingDetail}
                  className="flex-shrink-0 p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
                  title={selectedDetailDay === 0 && detailWeekOffset > 0 ? "Semaine suivante (plus r√©cente)" : "Jour suivant (plus r√©cent)"}
                >
                  {isLoadingDetail && selectedDetailDay === 0 ? (
                    <Loader2 className="w-5 h-5 animate-spin" />
                  ) : (
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                  )}
                </button>

                {/* Tabs container */}
                <div className="flex-1 flex gap-2 border-b border-gray-200 dark:border-gray-700 overflow-hidden">
                  {detailByDayData.map((dayData, idx) => {
                    const date = new Date(dayData.date)
                    const dayLabel = date.toLocaleDateString('fr-FR', {
                      weekday: 'short',
                      day: '2-digit',
                      month: 'short'
                    })

                    return (
                      <button
                        key={dayData.date}
                        onClick={() => setSelectedDetailDay(idx)}
                        className={`flex-1 px-4 py-3 font-medium transition-colors rounded-t-lg ${
                          selectedDetailDay === idx
                            ? 'text-primary-600 dark:text-primary-400 bg-primary-50 dark:bg-primary-900/20 border-b-2 border-primary-600 dark:border-primary-400'
                            : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/30'
                        }`}
                      >
                        <div className="flex flex-col items-center gap-1">
                          <span className="text-sm whitespace-nowrap">{dayLabel}</span>
                          <span className="text-xs font-semibold text-blue-600 dark:text-blue-400">
                            {dayData.totalEnergyKwh.toFixed(2)} kWh
                          </span>
                        </div>
                      </button>
                    )
                  })}
                </div>

                {/* Right button - Go to older (past) */}
                <button
                  onClick={() => {
                    // If already at last day (oldest), load previous (older) week
                    if (selectedDetailDay === detailByDayData.length - 1) {
                      setDetailWeekOffset(prev => prev + 1)
                      // When going to previous week (older), select the first day of that week (day just before)
                      setSelectedDetailDay(0)
                      toast.success('Chargement de la semaine pr√©c√©dente...')
                    } else {
                      setSelectedDetailDay(prev => prev + 1)
                    }
                  }}
                  disabled={isLoadingDetail}
                  className="flex-shrink-0 p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
                  title={selectedDetailDay === detailByDayData.length - 1 ? "Semaine pr√©c√©dente (plus ancienne)" : "Jour pr√©c√©dent (plus ancien)"}
                >
                  {isLoadingDetail && selectedDetailDay === detailByDayData.length - 1 ? (
                    <Loader2 className="w-5 h-5 animate-spin" />
                  ) : (
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                    </svg>
                  )}
                </button>
              </div>

              {/* Graph for selected day */}
              <div className="relative">
                {/* Always render the graph container to maintain height */}
                <div className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600 min-h-[500px]">
                  {/* Content based on state */}
                  {detailByDayData.length > 0 && detailByDayData[selectedDetailDay] ? (
                    <>
                      <div className="mb-2 text-sm text-gray-600 dark:text-gray-400">
                        {detailByDayData[selectedDetailDay].data.length} points de mesure pour cette journ√©e
                      </div>
                      <ResponsiveContainer width="100%" height={400}>
                        <LineChart data={detailByDayData[selectedDetailDay].data}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.1} />
                          <XAxis
                            dataKey="time"
                            stroke="#6B7280"
                            style={{ fontSize: '11px' }}
                            interval="preserveStartEnd"
                          />
                          <YAxis
                            stroke="#6B7280"
                            style={{ fontSize: '14px' }}
                            label={{ value: 'Puissance (kW)', angle: -90, position: 'insideLeft' }}
                            domain={[0, 'auto']}
                          />
                          <Tooltip
                            cursor={{ stroke: '#3B82F6', strokeWidth: 2 }}
                            contentStyle={{
                              backgroundColor: '#1F2937',
                              border: '1px solid #374151',
                              borderRadius: '8px',
                              color: '#F9FAFB'
                            }}
                            formatter={(value: number, _name: string, props: any) => {
                              const dataPoint = props.payload
                              if (!dataPoint) return [`${value.toFixed(3)} kW`, 'Puissance moyenne']

                              return [
                                <div key="tooltip-content" className="flex flex-col gap-1">
                                  <div className="font-semibold">{value.toFixed(3)} kW</div>
                                  <div className="text-xs text-gray-300">
                                    √ânergie: {dataPoint.energyKwh.toFixed(4)} kWh
                                  </div>
                                  <div className="text-xs text-gray-400">
                                    ({dataPoint.energyWh.toFixed(1)} Wh)
                                  </div>
                                </div>,
                                'Puissance moyenne'
                              ]
                            }}
                            labelFormatter={(label) => `Heure: ${label}`}
                          />
                          <Legend />
                          <Line
                            type="monotone"
                            dataKey="power"
                            stroke="#3B82F6"
                            strokeWidth={2}
                            dot={false}
                            activeDot={{ r: 6 }}
                            name="Consommation"
                          />
                        </LineChart>
                      </ResponsiveContainer>
                    </>
                  ) : (
                    // Empty state when no data
                    <div className="flex items-center justify-center h-[468px]">
                      <div className="flex flex-col items-center justify-center gap-4 text-center">
                        <BarChart3 className="text-gray-400 dark:text-gray-600" size={48} />
                        <p className="text-gray-600 dark:text-gray-400">
                          Aucune donn√©e d√©taill√©e disponible pour cette p√©riode
                        </p>
                        {detailDateRange && (
                          <p className="text-xs text-gray-500 dark:text-gray-500">
                            P√©riode demand√©e : du {new Date(detailDateRange.start).toLocaleDateString('fr-FR')} au {new Date(detailDateRange.end).toLocaleDateString('fr-FR')}
                          </p>
                        )}
                      </div>
                    </div>
                  )}
                </div>

                {/* Loading overlay - positioned absolutely on top */}
                {isLoadingDetail && (
                  <div className="absolute inset-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm rounded-lg flex items-center justify-center">
                    <div className="flex flex-col items-center justify-center gap-4 p-8">
                      <Loader2 className="animate-spin text-primary-600 dark:text-primary-400" size={48} />
                      <p className="text-gray-900 dark:text-white font-semibold text-center">
                        Chargement des donn√©es d√©taill√©es...
                      </p>
                      {detailDateRange && (
                        <p className="text-sm text-gray-600 dark:text-gray-400">
                          Du {new Date(detailDateRange.start).toLocaleDateString('fr-FR')} au {new Date(detailDateRange.end).toLocaleDateString('fr-FR')}
                        </p>
                      )}
                    </div>
                  </div>
                )}
              </div>

              {/* Info note - only show when we have data */}
              {detailByDayData.length > 0 && (
                <div className="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                  <p className="text-sm text-blue-800 dark:text-blue-200">
                    <strong>‚ÑπÔ∏è Note :</strong> Ces graphiques montrent votre consommation √©lectrique d√©taill√©e avec des mesures √† intervalles r√©guliers
                    ({detailData?.meter_reading?.reading_type?.interval_length === 'P30M' ? '30 minutes' :
                      detailData?.meter_reading?.reading_type?.interval_length === 'P15M' ? '15 minutes' :
                      detailData?.meter_reading?.reading_type?.interval_length || 'variables'})
                    pour les 7 derniers jours.
                    Cela vous permet d'identifier pr√©cis√©ment vos pics de consommation et d'optimiser votre utilisation.
                    <br/><br/>
                    <strong>üí° Calcul :</strong> Les valeurs sont en puissance moyenne (kW) pour chaque intervalle.
                    L'√©nergie consomm√©e pendant l'intervalle est calcul√©e en tenant compte de la dur√©e
                    (√ânergie = Puissance √ó Dur√©e). Le total journalier affich√© dans les onglets correspond √† la somme
                    de tous les intervalles de la journ√©e.
                  </p>
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {/* Info Card */}
      <div className="card mt-6">
        <div className="bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800 p-6">
          <div className="flex items-start gap-3">
            <AlertCircle className="text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" size={20} />
            <div className="text-sm text-blue-800 dark:text-blue-200">
              <p className="font-semibold mb-2">Informations</p>
              <ul className="space-y-1 list-disc list-inside">
                <li>Les donn√©es sont r√©cup√©r√©es depuis l'API Enedis Data Connect</li>
                <li>L'endpoint utilis√© est <code className="bg-blue-100 dark:bg-blue-900/50 px-1.5 py-0.5 rounded">consumption/daily</code> (relev√©s quotidiens)</li>
                <li>Les donn√©es sont mises en cache pour optimiser les performances</li>
                <li>R√©cup√©ration automatique de 1095 jours d'historique (limite maximale Enedis)</li>
                <li>Les donn√©es Enedis ne sont disponibles qu'en J-1 (hier)</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      {/* Empty State */}
      {!consumptionData && !isLoading && (
        <div className="card mt-6 p-12 text-center">
          <TrendingUp className="mx-auto text-gray-400 mb-4" size={48} />
          <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
            Aucune donn√©e √† afficher
          </h3>
          <p className="text-gray-600 dark:text-gray-400">
            S√©lectionnez un PDL et cliquez sur "R√©cup√©rer 3 ans d'historique depuis Enedis"
          </p>
        </div>
      )}

      {/* Confirmation Modal */}
      {showConfirmModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6 border border-gray-200 dark:border-gray-700">
            {/* Modal Header */}
            <div className="flex items-center gap-3 mb-4">
              <div className="flex-shrink-0 w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                <AlertCircle className="text-red-600 dark:text-red-400" size={24} />
              </div>
              <h3 className="text-xl font-semibold text-gray-900 dark:text-white">
                Confirmation requise
              </h3>
            </div>

            {/* Modal Content */}
            <div className="mb-6">
              <p className="text-gray-700 dark:text-gray-300 mb-4">
                √ätes-vous s√ªr de vouloir vider tout le cache ?
              </p>
              <div className="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 p-4 rounded">
                <p className="text-sm text-yellow-800 dark:text-yellow-200">
                  <strong>‚ö†Ô∏è Attention :</strong> Cette action va supprimer :
                </p>
                <ul className="text-sm text-yellow-700 dark:text-yellow-300 mt-2 ml-4 list-disc space-y-1">
                  <li>Tout le cache du navigateur (localStorage, sessionStorage, IndexedDB)</li>
                  <li>Toutes les donn√©es en cache Redis</li>
                </ul>
                <p className="text-sm text-yellow-800 dark:text-yellow-200 mt-3">
                  Cette action est <strong>irr√©versible</strong> et la page se rechargera automatiquement.
                </p>
              </div>
            </div>

            {/* Modal Actions */}
            <div className="flex gap-3 justify-end">
              <button
                onClick={() => setShowConfirmModal(false)}
                className="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors font-medium"
              >
                Annuler
              </button>
              <button
                onClick={confirmClearCache}
                className="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white transition-colors font-medium flex items-center gap-2"
              >
                <Trash2 size={18} />
                Vider le cache
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
